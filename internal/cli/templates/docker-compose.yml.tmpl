services:
  # External service (behind fiso-link egress proxy)
  external-api:
    image: hashicorp/http-echo:latest
    command: ["-text={\"enrichment\":\"data-from-external\"}", "-listen=:80"]

  # Egress proxy — user-service calls this to reach external-api
  fiso-link:
    image: ghcr.io/lsm/fiso-link:latest
    volumes:
      - ./link:/etc/fiso/link:ro
    environment:
      FISO_LINK_CONFIG: /etc/fiso/link/config.yaml
    depends_on:
      - external-api

  # Your backend business logic (edit or replace this service)
  # Only started in docker mode: fiso dev --docker
  user-service:
    build:
      context: ./user-service
    environment:
      FISO_LINK_ADDR: http://fiso-link:3500
    depends_on:
      - fiso-link
    profiles:
      - docker

  # Ingress — receives HTTP events, forwards to user-service
  fiso-flow:
    image: ghcr.io/lsm/fiso-flow:latest
    ports:
      - "8081:8081"
    volumes:
      - ./flows:/etc/fiso/flows:ro
    environment:
      FISO_CONFIG_DIR: /etc/fiso/flows
      FISO_METRICS_ADDR: ":9090"

  prometheus:
    image: prom/prometheus:v2.54.0
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9091:9090"
    profiles:
      - monitoring
